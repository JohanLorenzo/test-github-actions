name: GitHub Actions Demo
on: [push]
jobs:
  get_repo_config:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - id: set_docker_images
        run: echo "::set-output name=docker_images::[$(for folder in $(find docker -maxdepth 1 -mindepth 1); do echo -n "\"$folder\", "; done)]"

    outputs:
      docker_images: ${{ steps.set_docker_images.outputs.docker_images }}

  build_docker_images:
    needs: get_repo_config
    runs-on: ubuntu-20.04
    container:
      image: ubuntu:21.04
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}

    strategy:
      matrix:
        docker_image: ${{ fromJSON(needs.get_repo_config.outputs.docker_images) }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Set hash path
        run: echo "hash_path='${{ matrix.docker_image }}/**'" >> $GITHUB_ENV
      - name: Set image hash
        run: echo "image_hash=${{ hashFiles('${{ env.hash_path }}') }}" >> $GITHUB_ENV
      - run: echo "${{ env.image_hash }}"
      - name: Build docker image
        uses: docker://gcr.io/kaniko-project/executor
        with:
          args: "--dockerfile /github/workspace/docker/python-tools/Dockerfile --no-push"
